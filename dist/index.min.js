"use strict";var __awaiter=this&&this.__awaiter||function(t,a,s,l){return new(s=s||Promise)(function(n,e){function i(t){try{o(l.next(t))}catch(t){e(t)}}function r(t){try{o(l.throw(t))}catch(t){e(t)}}function o(t){var e;t.done?n(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(i,r)}o((l=l.apply(t,a||[])).next())})};((i,f)=>{const s={ids:{chat:{input:"input",anchor:"bubble"},links:{form:"link-form",modal:"link-modal"},quotas:{api:"api-quotas"}},classes:{links:{modal:"link-modal"},styles:{collapsed:"collapsed",primaryBckg:"bckg-primary",primaryColor:"color-primary"},quotas:{api:"api-quotas"}}};const y=()=>((t,e)=>{var n="http://www.w3.org/2000/svg";const i=document.createElementNS(n,"svg");i.classList.add("svg-icon",t),i.setAttribute("width","18"),i.setAttribute("height","18"),i.setAttribute("viewBox","0 0 18 18"),i.setAttribute("aria-hidden","true");const r=document.createElementNS(n,"path");return r.setAttribute("d",e),i.append(r),i})("iconClear","M15 4.41 13.59 3 9 7.59 4.41 3 3 4.41 7.59 9 3 13.59 4.41 15 9 10.41 13.59 15 15 13.59 10.41 9 15 4.41z"),g=({id:t},e)=>{const n=document.createElement("label");return n.htmlFor=t,n.textContent=e,n},w=t=>{var e=i.getSelection();if(e){var{anchorNode:n}=e;if(n&&n.id===t)return e}},b=(t,e,n)=>{t.classList.add(e);t=t.querySelector("[type=button]");t&&((t,e)=>{t.blur();const n=f.getElementById(e);n&&n.focus()})(t,n)},k=(t,e)=>{t.classList.remove(e);const[n]=[...t.querySelectorAll("input")];return n.focus(),t};(t=>{var e,n=f.createElement("style");f.head.append(n);const{sheet:i}=n;i&&({classes:{links:e,styles:n,quotas:t}}=t,i.insertRule(`
        :root {
            --white: #c4c8cc;
            --black: #2d2d2d;
            --button-primary: #378ad3;
        }`),i.insertRule(`
        .${n.primaryBckg} {
            background-color: var(--black) !important;
        }`),i.insertRule(`
        .${n.primaryColor} {
            color: var(--white) !important;
        }`),i.insertRule(`
        .${e.modal} .iconClear {
            position: absolute;
            top: 0;
            right: 0;
            margin: 1vh;
            fill: var(--white);
        }`),i.insertRule(`
        .${e.modal} {
            position: fixed;
            top: calc(100% / 3);
            left: calc(100% / 3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 1vh;
            z-index: 9999;
            max-width: 50vw;
            max-height: 25vh;
            overflow: hidden;

            transition: max-width 0.1s linear, max-height 0.1s linear;
        }`),i.insertRule(`
        .${n.collapsed} {
            max-width: 0px !important;
            max-height: 0px !important;
        }`),i.insertRule(`
        .${e.modal} form {
            padding: 1vh 1vw;
        }`),i.insertRule(`
        .${e.modal} input {
            box-sizing: border-box;
            border-radius: 0.5vh;
            padding: 1vh 1vw;
            width: 100%;
            outline: none;
            background: none;
            color: var(--white);
        }`),i.insertRule(`
        .${e.modal} label {
            display: inline-block;
            margin: 0 0 1vh 0.25vw;
            color: var(--white);
            font-size: 0.9rem;
        }`),i.insertRule(`
        .${e.modal} button {
            height: 4vh;
            min-width: 8vh;
            border-radius: 0.5vh 0.5vw;
            border: none;
            background-color: rgb(55, 138, 211);
            color: white;
        }`),i.insertRule(`
        .${e.modal} button:hover {
            background-color: #3ca4ff;
        }`),i.insertRule(`
        .${e.modal} .${t.api} {
            cursor: initial;
            margin-left: 0.5vw;
            color: var(--black);
            transition: color 0.5s linear 0s;
        }`),i.insertRule(`
        .${e.modal} input {
            margin-bottom: 1vh;
        }`))})(s);const l=[{key:"L",ctrl:!0,shift:!1,caseSensitive:!1,action:({ids:i,classes:r})=>{const t=w(i.chat.anchor),{styles:{collapsed:e}}=r,{chat:n}=i;var o=(null===t||void 0===t?void 0:t.toString())||"",a=f.getElementById(i.links.modal);if(a)return((t,e,n)=>{const[,i]=[...t.querySelectorAll("input")];return i.value=e,k(t,n)})(a,o,e);const s=f.createElement("div");s.classList.add(r.links.modal,r.styles.primaryBckg,e),s.id=i.links.modal;const l=y();l.addEventListener("click",()=>b(s,e,n.input));const c=f.createElement("form");c.id=i.links.form;const d=f.createElement("input");d.type="text";const u=f.createElement("input");u.type="text",u.value=o;var m=((t,e)=>{const n=document.createElement("span");n.classList.add(e),n.textContent="SE API quota remaining: ";const i=document.createElement("span");return i.id=t,n.append(i),n})(i.quotas.api,r.quotas.api);let p=300;d.addEventListener("change",()=>__awaiter(void 0,void 0,void 0,function*(){var s,l,o,{value:t}=d;if(/https?:\/\/(www\.)?(meta\.)?stack(?:overflow|exchange)\.com/.test(t)){var[e,n]=(s=t,l=p,yield __awaiter(void 0,void 0,void 0,function*(){var[,t="stackoverflow"]=s.match(/((?:meta\.)?[\w-]+)\.com/i)||[];let e;for(const a of[`https?:\\/\\/${t}\\.com\\/questions\\/\\d+\\/.+?\\/(\\d+)`,`https?:\\/\\/${t}\\.com\\/questions\\/(\\d+)\\/.+?(?:\\/(\\d+)|$)`,`https?:\\/\\/${t}\\.com\\/(?:a|q)\\/(\\d+)`]){var n=new RegExp(a,"i"),[,n]=s.match(n)||[];if(n){e=n;break}}var i=["",l];if(!e)return i;const r=yield fetch(`https://api.stackexchange.com/2.2/posts/${e}?site=${t}&filter=Bqe1ika.a`);if(!r.ok)return i;var{items:o,quota_remaining:t}=yield r.json();if(!o.length)return i;var[{title:o}]=o;return[o,t]}));return u.value||(u.value=e),p=n,((t,e,n)=>{const i=f.getElementById(t);if(i){const{parentElement:r}=i;r&&(i.textContent=n.toString(),r.classList.add(e),setTimeout(()=>r.classList.remove(e),3e3))}})(i.quotas.api,r.styles.primaryColor,p)}u.value||(u.value=(o=t,yield __awaiter(void 0,void 0,void 0,function*(){try{const i=yield fetch(o);if(200!==i.status)return"";var t=yield i.text();const r=(new DOMParser).parseFromString(t,"text/html");var e=r.querySelector("[property='og:title']"),{title:n}=r;return e?e.content:n}catch(t){return console.debug(`failed to fetch link or parse: ${t}`),""}})))}));a=g(d,"Link"),o=g(u,"Title");const v=(t=>{const e=document.createElement("button");return e.type="button",e.textContent=t,e})("Add link");v.addEventListener("click",()=>{var t=`[${u.value}](${d.value})`;((t,e,n)=>{const i=f.getElementById(e);if(!i)return;const r=w(t);t=(null===r||void 0===r?void 0:r.toString())||"";i.value=i.value.replace(t,n)})(n.anchor,n.input,t),b(s,e,n.input)}),c.append(a,d,o,u,v,m),s.append(l,c);const{body:h}=f;return h.append(s),k(s,e)}},{key:"Escape",ctrl:!1,shift:!1,caseSensitive:!1,action:({ids:t,classes:e})=>{var n=f.getElementById(t.links.modal);return n&&b(n,e.styles.collapsed,t.chat.input),n}}];f.addEventListener("keydown",t=>{const{ctrlKey:e,metaKey:n,shiftKey:i,key:r}=t;var o=l.find(t=>(({ctrl:t,shift:e},n,i,r)=>(n===t||i===t)&&r===e)(t,e,n,i)&&(({key:t,caseSensitive:e},n)=>e?t===n:t.toUpperCase()===n.toUpperCase())(t,r));if(o){t.preventDefault();const{action:a}=o;a(s,o)}})})(window,document);