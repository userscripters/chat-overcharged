// ==UserScript==
// @author          Oleg Valter
// @description     Chat experience improvements
// @grant           none
// @homepage        https://github.com/userscripters/template#readme
// @match           *://chat.stackexchange.com/*
// @match           *://chat.stackoverflow.com/*
// @name            chat-overcharge
// @source          git+https://github.com/userscripters/template.git
// @supportURL      https://github.com/userscripters/template/issues
// @version         1.5.1
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,o,l,s){return new(l=l||Promise)(function(n,t){function r(e){try{i(s.next(e))}catch(e){t(e)}}function a(e){try{i(s.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof l?t:new l(function(e){e(t)})).then(r,a)}i((s=s.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(n,r){var a,i,o,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;l;)try{if(a=1,i&&(o=2&t[0]?i.return:t[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,t[1])).done)return o;switch(i=0,(t=o?[2&t[0],o.value]:t)[0]){case 0:case 1:o=t;break;case 4:return l.label++,{value:t[1],done:!1};case 5:l.label++,i=t[1],t=[0];continue;case 7:t=l.ops.pop(),l.trys.pop();continue;default:if(!(o=0<(o=l.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){l=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){l.label=t[1];break}if(6===t[0]&&l.label<o[1]){l.label=o[1],o=t;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(t);break}o[2]&&l.ops.pop(),l.trys.pop();continue}t=r.call(n,l)}catch(e){t=[6,e],i=0}finally{a=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,a,i=n.call(e),o=[];try{for(;(void 0===t||0<t--)&&!(r=i.next()).done;)o.push(r.value)}catch(e){a={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(a)throw a.error}}return o},__spreadArray=this&&this.__spreadArray||function(e,t){for(var n=0,r=t.length,a=e.length;n<r;n++,a++)e[a]=t[n];return e},__values=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&r>=e.length?void 0:e)&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};!function(l,y){function c(e,t){var n=e.id;return(e=document.createElement("label")).htmlFor=n,e.textContent=t,e}function f(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=document.createElement("button");return r.type="button",r.textContent=e,(e=r.classList).add.apply(e,__spreadArray([],__read(t))),r}function h(e,t,n){e.classList.add(t),(e=e.querySelector("[type=button]"))&&r(e,n)}var n={ids:{chat:{input:"input",anchor:"bubble"},links:{form:"link-form",modal:"link-modal"},quotas:{api:"api-quotas"}},classes:{buttons:{primary:"btn-primary",secondary:"btn-secondary"},links:{modal:"link-modal"},styles:{collapsed:"collapsed",primaryBckg:"bckg-primary",primaryColor:"color-primary"},quotas:{api:"api-quotas"}}},g=function(e,t){var n="http://www.w3.org/2000/svg",r=document.createElementNS(n,"svg");r.classList.add("svg-icon",e),r.setAttribute("width","18"),r.setAttribute("height","18"),r.setAttribute("viewBox","0 0 18 18"),r.setAttribute("aria-hidden","true");n=document.createElementNS(n,"path");return n.setAttribute("d",t),r.append(n),r},r=function(e,t){e.blur();t=y.getElementById(t);t&&t.focus()},b=function(e,t){return e.classList.remove(t),__read(__spreadArray([],__read(e.querySelectorAll("input"))),1)[0].focus(),e};!function(e){var t=y.createElement("style");y.head.append(t);var n,r,a,i,o=t.sheet;o&&(i=(n=(a=e.classes).buttons).primary,r=n.secondary,t=a.links.modal,e=a.styles,n=a.quotas,o.insertRule("\n        :root {\n            --white: #c4c8cc;\n            --black: #2d2d2d;\n            --button-primary: #378ad3;\n        }"),o.insertRule("\n        ."+e.primaryBckg+" {\n            background-color: var(--black) !important;\n        }"),o.insertRule("\n        ."+e.primaryColor+" {\n            color: var(--white) !important;\n        }"),o.insertRule("\n        ."+t+" .iconClear {\n            position: absolute;\n            top: 0;\n            right: 0;\n            margin: 1vh;\n            fill: var(--white);\n        }"),o.insertRule("\n        ."+t+" {\n            position: fixed;\n            top: calc(100% / 3);\n            left: calc(100% / 3);\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            border-radius: 1vh;\n            z-index: 9999;\n            max-width: 50vw;\n            max-height: 25vh;\n            overflow: hidden;\n\n            transition: max-width 0.1s linear, max-height 0.1s linear;\n        }"),o.insertRule("\n        ."+e.collapsed+" {\n            max-width: 0px !important;\n            max-height: 0px !important;\n        }"),o.insertRule("\n        ."+t+" form {\n            padding: 1vh 1vw;\n        }"),o.insertRule("\n        ."+t+" input {\n            box-sizing: border-box;\n            border-radius: 0.5vh;\n            padding: 1vh 1vw;\n            width: 100%;\n            outline: none;\n            background: none;\n            color: var(--white);\n        }"),o.insertRule("\n        ."+t+" label {\n            display: inline-block;\n            margin: 0 0 1vh 0.25vw;\n            color: var(--white);\n            font-size: 0.9rem;\n        }"),a=t,e=i,i=r,(r=o).insertRule("\n        ."+a+" ."+e+",\n        ."+a+" ."+i+" {\n            height: 4vh;\n            min-width: 8vh;\n            outline: none;\n            border: none;\n            border-radius: 0.5vh 0.5vw;\n        }"),r.insertRule("\n        ."+a+" ."+e+" {\n            background-color: rgb(55, 138, 211);\n            color: white;\n        }"),r.insertRule("\n        ."+a+" ."+i+" {\n            background-color: unset;\n            color: var(--white);\n        }"),r.insertRule("\n        ."+a+" ."+e+":hover,\n        ."+a+" ."+e+":focus {\n            background-color: #3ca4ff;\n        }"),r.insertRule("\n        ."+a+" ."+i+":hover,\n        ."+a+" ."+i+":focus {\n            color: white;\n        }"),o.insertRule("\n        ."+t+" ."+n.api+" {\n            cursor: initial;\n            margin-left: 0.5vw;\n            color: var(--black);\n            transition: color 0.5s linear 0s;\n        }"),o.insertRule("\n        ."+t+" input {\n            margin-bottom: 1vh;\n        }"),o.insertRule("\n        ."+t+"[draggable=true] {\n            cursor: move;\n        }"))}(n);var a=[{key:"L",ctrl:!0,shift:!1,caseSensitive:!1,action:function(e){var u=e.ids,d=e.classes,t=d.styles.collapsed,n=y.getElementById(u.chat.input);if(!n)return null;var r=n.selectionStart,a=n.selectionEnd,i=n.value.slice(r,a),o=y.getElementById(u.links.modal);if(o)return function(e,t,n){var r=__read(__spreadArray([],__read(e.querySelectorAll("input"))),2);r[0];return r[1].value=t,b(e,n)}(o,i,t);var l=y.createElement("div");l.classList.add(d.links.modal,d.styles.primaryBckg,t),l.id=u.links.modal,l.draggable=!0;e=g("iconClear","M15 4.41 13.59 3 9 7.59 4.41 3 3 4.41 7.59 9 3 13.59 4.41 15 9 10.41 13.59 15 15 13.59 10.41 9 15 4.41z");e.addEventListener("click",function(){return h(l,t,u.chat.input)});var s=y.createElement("form");s.id=u.links.form;var p=y.createElement("input");p.type="text";var v=y.createElement("input");v.type="text",v.value=i;var n=function(e,t){var n=document.createElement("span");n.classList.add(t),n.textContent="SE API quota remaining: ";t=document.createElement("span");return t.id=e,n.append(t),n}(u.quotas.api,d.quotas.api),m=300;p.addEventListener("change",function(){return __awaiter(void 0,void 0,void 0,function(){var o,l,s,c;return __generator(this,function(e){switch(e.label){case 0:return o=p.value,/https?:\/\/(www\.)?(meta\.)?stack(?:overflow|exchange)\.com/.test(o)?[4,(f=o,h=m,__awaiter(void 0,void 0,void 0,function(){var t,n,r,a,i,o,l,s,c,u,d,p,v;return __generator(this,function(e){switch(e.label){case 0:t=__read(f.match(/((?:meta\.)?[\w-]+)\.com/i)||[],2),c=t[1],c=["https?:\\/\\/"+(t=void 0===c?"stackoverflow":c)+"\\.com\\/questions\\/\\d+\\/.+?\\/(\\d+)","https?:\\/\\/"+t+"\\.com\\/questions\\/(\\d+)\\/.+?(?:\\/(\\d+)|$)","https?:\\/\\/"+t+"\\.com\\/(?:a|q)\\/(\\d+)"];try{for(r=__values(c),a=r.next();!a.done;a=r.next())if(i=a.value,o=new RegExp(i,"i"),l=__read(f.match(o)||[],2),s=l[1]){n=s;break}}catch(e){p={error:e}}finally{try{a&&!a.done&&(v=r.return)&&v.call(r)}finally{if(p)throw p.error}}return(c=["",h],n)?((u=new URL("https://api.stackexchange.com/2.2/posts/"+n)).search=new URLSearchParams({site:t,key:"nWopg6u2CiSfx8SXs3dyVg((",filter:"Bqe1ika.a"}).toString(),[4,fetch(u.toString())]):[2,c];case 1:return(d=e.sent()).ok?[4,d.json()]:[2,c];case 2:return(u=e.sent(),d=u.items,u=u.quota_remaining,d.length)?(d=__read(d,1),[2,[d[0].title,u]]):[2,c]}})}))]:[3,2];case 1:return s=__read.apply(void 0,[e.sent(),2]),l=s[0],s=s[1],v.value||(v.value=l),m=s,[2,(t=u.quotas.api,n=d.styles.primaryColor,a=m,void(!(t=y.getElementById(t))||(i=t.parentElement)&&(t.textContent=a.toString(),i.classList.add(n),setTimeout(function(){return i.classList.remove(n)},3e3))))];case 2:return v.value?[3,4]:(c=v,[4,(r=o,__awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,3,,4]),[4,fetch(r)];case 1:return 200!==(t=e.sent()).status?[2,""]:[4,t.text()];case 2:return t=e.sent(),n=(new DOMParser).parseFromString(t,"text/html"),t=n.querySelector("[property='og:title']"),n=n.title,[2,t?t.content:n];case 3:return n=e.sent(),console.debug("failed to fetch link or parse: "+n),[2,""];case 4:return[2]}})}))]);case 3:c.value=e.sent(),e.label=4;case 4:return[2]}var r,t,n,a,i,f,h})})});r=c(p,"Link"),a=c(v,"Title"),o=f("Add link","btn-primary");o.addEventListener("click",function(){var e="["+v.value+"]("+p.value+")";!function(e,t){var n=y.getElementById(e);if(!n)return;var r=n.selectionStart,a=n.selectionEnd,e=n.value;if(r===a)return n.value+=t;a=e.slice(r,a);n.value=e.replace(a,t)}(u.chat.input,e),h(l,t,u.chat.input)});i=f("Clear","btn-secondary");return i.addEventListener("click",function(){return s.reset()}),s.append(r,p,a,v,o,i,n),l.append(e,s),y.body.append(l),b(l,t)}},{key:"Escape",ctrl:!1,shift:!1,caseSensitive:!1,action:function(e){var t=e.ids,n=e.classes,e=y.getElementById(t.links.modal);return e&&h(e,n.styles.collapsed,t.chat.input),e}}];y.addEventListener("keydown",function(e){var i=e.ctrlKey,o=e.metaKey,l=e.shiftKey,s=e.key,t=a.find(function(e){return n=o,r=l,a=(t=e).ctrl,t=e.shift,(i===a||n===a)&&r===t&&(r=s,t=e.key,e.caseSensitive?t===r:t.toUpperCase()===r.toUpperCase());var t,n,r,a});t&&(e.preventDefault(),(0,t.action)(n,t))});var s=n.ids.links.modal;y.addEventListener("dragstart",function(e){var t=e.dataTransfer,e=y.createElement("img");e.src="data:image/png;base64,AAAAAA==",null!=t&&t.setDragImage(e,0,0)});var u=0,d=0;y.addEventListener("drag",function(e){var t,n,r=e.dataTransfer,a=e.target,i=e.clientX,o=e.clientY;a.id===s&&r&&(t=a.style,u=u||i,d=d||o,r=(e=a.style).top,e=e.left,r||e||(r=(n=l.getComputedStyle(a)).top,e=n.left),a=i-u,n=o-d,t.left=parseInt(e)+a+"px",t.top=parseInt(r)+n+"px",u=i,d=o)}),y.addEventListener("dragover",function(e){return e.preventDefault()})}(window,document);